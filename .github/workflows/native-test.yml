name: Test on Native

on:
  pull_request:
    branches:
      - '**'

  workflow_dispatch:

jobs:
  test-native:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout avionics repo
        uses: actions/checkout@v4
        with:
          path: avionics

      - name: Clone Native repo
        run: |
          git clone https://github.com/CURocketEngineering/Native native

      - name: Replace Native lib avionics with checked-out avionics code
        run: |
          rm -rf native/lib/avionics
          mkdir -p native/lib
          mv avionics native/lib/avionics

      - name: Show native directory structure
        run: |
          echo "===== native directory tree ====="
          ls -R native

      - name: Download Rocket-test-data v1.0.0 release CSVs
        run: |
          mkdir -p native/data
          curl -s https://api.github.com/repos/CURocketEngineering/Rocket-test-data/releases/tags/v1.0.0 \
            | jq -r '.assets[].browser_download_url' \
            | while read url; do
                echo "Downloading $url"
                curl -L "$url" -o native/data/$(basename "$url")
              done

      - name: Install PlatformIO Core
        run: |
          pip install -U platformio

      - name: Run PlatformIO Tests
        working-directory: ./native
        run: |
          pio test -e native
